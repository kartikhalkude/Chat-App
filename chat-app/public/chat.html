<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp-like Chat</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="chat.css">
    <style>

    </style>
</head>

<body>
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-close" id="authClose">
                <i class="fas fa-times"></i>
            </div>
            <h2 id="authTitle">Login</h2>
            <form id="authForm">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit" id="authSubmit">Login</button>
            </form>
            <p class="auth-toggle" id="authToggle">Don't have an account? Register</p>
        </div>
    </div>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="profile-header">
                <div class="avatar" id="userAvatar"></div>
                <div id="username-display"></div>
                <div style="display: flex; gap: 1rem;">
                    <button id="dark-mode-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Search users...">
                </div>
            </div>
            <div class="user-list" id="user-list"></div>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="welcome-screen" id="welcome-screen">
                <i class="fas fa-comments"></i>
                <h2>Welcome to WhatsApp-like Chat</h2>
                <p>Select a user to start chatting</p>
            </div>
            <div class="chat-content" id="chat-content" style="display: none;">
                <div class="chat-header">
                    <div class="back-button" id="back-button">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="avatar" id="receiverAvatar"></div>
                    <div id="selected-user"></div>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <form class="message-form" id="message-form">
                    <input type="text" class="message-input" id="message-input" placeholder="Type a message">
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    </div>
    <script>
        const authClose = document.getElementById('authClose');

        // Add the click event listener
        authClose.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
        const socket = io(window.location.origin);
        let currentUser = localStorage.getItem('username');
        let currentReceiver = null;
        let isLogin = true;
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const body = document.body;
        const prefersDark = window.matchMedia('(prefers-color-scheme: light)').matches;
        let isDarkMode = localStorage.getItem('darkMode') === 'true' || prefersDark;
        const sidebar = document.getElementById('sidebar');
        const backButton = document.getElementById('back-button');
        if (isDarkMode) {
            body.classList.add('dark-mode');
            darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        darkModeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            body.classList.toggle('dark-mode');
            darkModeToggle.innerHTML = isDarkMode ?
                '<i class="fas fa-sun"></i>' :
                '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', isDarkMode);
        });
        function showSidebar() {
            sidebar.classList.remove('hidden');
            document.getElementById('chat-content').style.display = 'none';
            document.getElementById('welcome-screen').style.display = 'flex';
        }
        function hideSidebar() {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('hidden');
            }
        }
        backButton.addEventListener('click', showSidebar);
        const authForm = document.getElementById('authForm');
        const authToggle = document.getElementById('authToggle');
        const authTitle = document.getElementById('authTitle');
        const authSubmit = document.getElementById('authSubmit');
        const authContainer = document.getElementById('authContainer');
        function toggleAuth() {
            isLogin = !isLogin;
            authTitle.textContent = isLogin ? 'Login' : 'Register';
            authSubmit.textContent = isLogin ? 'Login' : 'Register';
            authToggle.textContent = isLogin ? "Don't have an account? Register" : "Already have an account? Login";
        }
        authToggle.addEventListener('click', toggleAuth);
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`/${isLogin ? 'login' : 'register'}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (result.success) {
                    if (isLogin) {
                        localStorage.setItem('username', username);
                        currentUser = username;
                        authContainer.style.display = 'none';
                        initializeApp();
                    } else {
                        alert('Registration successful! Please login.');
                        toggleAuth();
                    }
                } else {
                    alert(result.message || `${isLogin ? 'Login' : 'Registration'} failed`);
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('Network error. Please try again.');
            }
        });
        function initializeApp() {
            if (!currentUser) {
                authContainer.style.display = 'flex';
                return;
            }
            document.getElementById('username-display').textContent = currentUser;
            document.getElementById('userAvatar').textContent = currentUser[0].toUpperCase();
            fetchUsers();
            authContainer.style.display = 'none';
        }
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('username');
            location.reload();
        });
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                const username = item.querySelector('.user-name').textContent.toLowerCase();
                item.style.display = username.includes(searchTerm) ? 'flex' : 'none';
            });
        });
        async function fetchUsers() {
            try {
                const response = await fetch('/users');
                const users = await response.json();
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                users.filter(user => user.username !== currentUser).forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'user-item';
                    const avatar = document.createElement('div');
                    avatar.className = 'avatar';
                    avatar.textContent = user.username[0].toUpperCase();
                    const userName = document.createElement('div');
                    userName.className = 'user-name';
                    userName.textContent = user.username;
                    const unreadDot = document.createElement('div');
                    unreadDot.className = 'unread-dot';
                    unreadDot.style.display = 'none';
                    unreadDot.dataset.username = user.username;
                    userDiv.appendChild(avatar);
                    userDiv.appendChild(userName);
                    userDiv.appendChild(unreadDot);
                    userDiv.addEventListener('click', () => selectUser(user.username));
                    userList.appendChild(userDiv);
                });
            } catch (error) {
                console.error('Failed to fetch users:', error);
            }
        }
        function selectUser(receiver) {
            currentReceiver = receiver;
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('chat-content').style.display = 'flex';
            document.getElementById('selected-user').textContent = receiver;
            document.getElementById('receiverAvatar').textContent = receiver[0].toUpperCase();
            const unreadDot = document.querySelector(`.unread-dot[data-username="${receiver}"]`);
            if (unreadDot) {
                unreadDot.style.display = 'none';
            }
            hideSidebar();
            loadMessages(receiver);
        }
        async function loadMessages(receiver) {
            try {
                const response = await fetch(`/messages/${currentUser}/${receiver}`);
                const messages = await response.json();
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender === currentUser ? 'sent' : 'received'}`;
                    messageDiv.textContent = msg.message;
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'message-time';
                    timeDiv.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    messageDiv.appendChild(timeDiv);
                    chatMessages.appendChild(messageDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }
        document.getElementById('message-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            if (message === '') return;
            const messageData = {
                sender: currentUser,
                receiver: currentReceiver,
                message: message,
                timestamp: new Date()
            };
            socket.emit('send_message', messageData);
            messageInput.value = '';
        });
        socket.on('receive_message', (messageData) => {
            const chatMessages = document.getElementById('chat-messages');
            if (messageData.sender === currentReceiver || messageData.receiver === currentReceiver) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${messageData.sender === currentUser ? 'sent' : 'received'}`;
                messageDiv.textContent = messageData.message;
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date(messageData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.appendChild(timeDiv);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            if (messageData.sender !== currentReceiver && messageData.receiver === currentUser) {
                const unreadDot = document.querySelector(`.unread-dot[data-username="${messageData.sender}"]`);
                if (unreadDot) {
                    unreadDot.style.display = 'block';
                }
            }
        });
        initializeApp();
    </script>
</body>

</html>